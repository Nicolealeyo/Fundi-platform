{% extends 'base.html' %}

{% block title %}Admin - Booking Detail{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-calendar-check"></i> Booking #{{ booking.id }}</h1>
        <a href="{% url 'admin_bookings' %}" class="btn btn-outline-primary">Back to Bookings</a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Booking Information</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <th>Customer:</th>
                            <td>{{ booking.customer.username }} ({{ booking.customer.email }})</td>
                        </tr>
                        <tr>
                            <th>Fundi:</th>
                            <td>{{ booking.fundi.user.username }} - {{ booking.fundi.get_category_display }}</td>
                        </tr>
                        <tr>
                            <th>Service:</th>
                            <td>{{ booking.service.name }}</td>
                        </tr>
                        <tr>
                            <th>Description:</th>
                            <td>{{ booking.description }}</td>
                        </tr>
                        <tr>
                            <th>Address:</th>
                            <td>{{ booking.address }}</td>
                        </tr>
                        <tr>
                            <th>Booking Date:</th>
                            <td>{{ booking.booking_date|date:"F d, Y H:i" }}</td>
                        </tr>
                        <tr>
                            <th>Estimated Hours:</th>
                            <td>{{ booking.estimated_hours }} hours</td>
                        </tr>
                        <tr>
                            <th>Total Cost:</th>
                            <td><strong>KSh {{ booking.total_cost }}</strong></td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td><span class="badge bg-{% if booking.status == 'completed' %}success{% elif booking.status == 'pending' %}warning{% elif booking.status == 'cancelled' %}danger{% else %}info{% endif %}">{{ booking.get_status_display }}</span></td>
                        </tr>
                        <tr>
                            <th>Created:</th>
                            <td>{{ booking.created_at|date:"F d, Y H:i" }}</td>
                        </tr>
                        <tr>
                            <th>Last Updated:</th>
                            <td>{{ booking.updated_at|date:"F d, Y H:i" }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Edit Status -->
            <div class="card">
                <div class="card-header">
                    <h5>Update Status</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'admin_edit_booking' booking.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select" data-no-custom-dropdown="true" id="admin-booking-status-select">
                                <option value="pending" {% if booking.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="confirmed" {% if booking.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                                <option value="in_progress" {% if booking.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                <option value="completed" {% if booking.status == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="cancelled" {% if booking.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Status</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Payment Information -->
            {% if payment %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Payment Information</h5>
                </div>
                <div class="card-body">
                    <p><strong>Amount:</strong> KSh {{ payment.amount }}</p>
                    <p><strong>Method:</strong> {{ payment.get_payment_method_display }}</p>
                    <p><strong>Status:</strong> <span class="badge bg-{% if payment.status == 'completed' %}success{% elif payment.status == 'pending' %}warning{% else %}danger{% endif %}">{{ payment.get_status_display }}</span></p>
                    <p><strong>Created:</strong> {{ payment.created_at|date:"F d, Y H:i" }}</p>
                    {% if payment.completed_at %}
                    <p><strong>Completed:</strong> {{ payment.completed_at|date:"F d, Y H:i" }}</p>
                    {% endif %}
                    {% if payment.transaction_id %}
                    <p><strong>Transaction ID:</strong> {{ payment.transaction_id }}</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="card mb-4">
                <div class="card-body">
                    <p class="text-muted">No payment information available</p>
                </div>
            </div>
            {% endif %}

            <!-- Review Information -->
            {% if review %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Review</h5>
                </div>
                <div class="card-body">
                    <p><strong>Rating:</strong> 
                        {% for i in "12345" %}
                            {% if forloop.counter <= review.rating %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                                <i class="bi bi-star text-warning"></i>
                            {% endif %}
                        {% endfor %}
                    </p>
                    <p><strong>Comment:</strong> {{ review.comment|default:"No comment" }}</p>
                    <p><strong>Created:</strong> {{ review.created_at|date:"F d, Y H:i" }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h5>Actions</h5>
                </div>
                <div class="card-body">
                    <a href="{% url 'admin_delete_booking' booking.id %}" class="btn btn-danger w-100" onclick="return confirm('Are you sure you want to delete this booking?')">
                        <i class="bi bi-trash"></i> Delete Booking
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Ensure admin status select shows all options - remove custom wrapper if exists
    document.addEventListener('DOMContentLoaded', function() {
        const statusSelect = document.querySelector('#admin-booking-status-select');
        if (statusSelect) {
            // Remove any custom wrapper
            const customWrapper = statusSelect.closest('.custom-select-wrapper');
            if (customWrapper) {
                const form = customWrapper.closest('form');
                if (form) {
                    const select = customWrapper.querySelector('select');
                    if (select) {
                        form.querySelector('.mb-3').appendChild(select);
                    }
                    customWrapper.remove();
                }
            }
            // Ensure select is visible and has all options
            statusSelect.style.display = 'block';
            statusSelect.style.visibility = 'visible';
            statusSelect.style.opacity = '1';
            console.log('Admin status select has', statusSelect.options.length, 'options');
        }
    });
</script>
{% endblock %}

