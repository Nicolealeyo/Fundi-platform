{% extends 'base.html' %}

{% block title %}{{ fundi.user.username }} - Fundi Platform{% endblock %}

{% block extra_css %}
<style>
    .fundi-profile-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.12),
                    0 10px 40px rgba(0, 0, 0, 0.08),
                    0 5px 15px rgba(0, 0, 0, 0.05),
                    inset 0 1px 0 rgba(255, 255, 255, 0.6);
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .fundi-profile-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }
    
    .fundi-profile-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 35px 100px rgba(102, 126, 234, 0.2),
                    0 15px 50px rgba(0, 0, 0, 0.1),
                    0 8px 20px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }
    
    .fundi-avatar {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid white;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3),
                    0 5px 15px rgba(0, 0, 0, 0.1),
                    inset 0 0 0 3px rgba(102, 126, 234, 0.1);
        transition: all 0.4s ease;
    }
    
    .fundi-avatar:hover {
        transform: scale(1.05) rotate(5deg);
        box-shadow: 0 15px 50px rgba(102, 126, 234, 0.4),
                    0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .fundi-category-badge {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        margin: 1rem 0;
    }
    
    .fundi-stats {
        display: flex;
        justify-content: space-around;
        margin: 1.5rem 0;
        padding: 1.5rem 0;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .fundi-stat-item {
        text-align: center;
    }
    
    .fundi-stat-value {
        font-size: 1.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .fundi-stat-label {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    
    .lottie-container {
        width: 100px;
        height: 100px;
        margin: 0 auto 1rem;
    }
    
    [data-theme="dark"] .fundi-profile-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.9) 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4),
                    0 10px 40px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .fundi-stat-label {
        color: #94a3b8;
    }
    
    .soft-shadow {
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08),
                    0 5px 15px rgba(0, 0, 0, 0.05),
                    0 2px 5px rgba(0, 0, 0, 0.03);
    }
    
    .depth-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1),
                    0 8px 25px rgba(0, 0, 0, 0.08),
                    0 3px 10px rgba(0, 0, 0, 0.05),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
    }
    
    .depth-card:hover {
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.12),
                    0 10px 35px rgba(0, 0, 0, 0.1),
                    0 5px 15px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 1);
        transform: translateY(-3px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-4">
            <div class="fundi-profile-card mb-4">
                <div class="card-body text-center p-4">
                    <!-- Lottie Animation for Fundi Service -->
                    <div id="fundiServiceAnimation" class="lottie-container"></div>
                    
                    {% if fundi.profile_picture %}
                        <img src="{{ fundi.profile_picture.url }}" class="fundi-avatar mb-3" alt="{{ fundi.user.username }}">
                    {% else %}
                        <div class="fundi-avatar mb-3 d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="bi bi-person-circle" style="font-size: 6rem; color: white; opacity: 0.9;"></i>
                        </div>
                    {% endif %}
                    
                    <h3 class="fw-bold mb-2">{{ fundi.user.get_full_name|default:fundi.user.username }}</h3>
                    <div class="fundi-category-badge">
                        <i class="bi bi-briefcase"></i> {{ fundi.get_category_display }}
                    </div>
                    
                    <div class="mb-3">
                        <span class="rating-stars" style="font-size: 1.2rem;">
                            {% for i in "12345" %}
                                {% if forloop.counter <= fundi.average_rating|floatformat:0|add:"0" %}
                                    <i class="bi bi-star-fill"></i>
                                {% else %}
                                    <i class="bi bi-star"></i>
                                {% endif %}
                            {% endfor %}
                        </span>
                        <div class="mt-2">
                            <strong>{{ fundi.average_rating|floatformat:1 }}</strong>
                            <span class="text-muted">({{ fundi.total_reviews }} reviews)</span>
                        </div>
                    </div>
                    
                    <div class="fundi-stats">
                        <div class="fundi-stat-item">
                            <div class="fundi-stat-value">KSh {{ fundi.hourly_rate }}</div>
                            <div class="fundi-stat-label">Per Hour</div>
                        </div>
                        <div class="fundi-stat-item">
                            <div class="fundi-stat-value">{{ fundi.experience_years }}</div>
                            <div class="fundi-stat-label">Years Exp.</div>
                        </div>
                    </div>
                    
                    {% if fundi.is_available %}
                        <span class="badge bg-success mb-3 px-3 py-2" style="font-size: 0.9rem;">
                            <i class="bi bi-check-circle"></i> Available Now
                        </span>
                    {% else %}
                        <span class="badge bg-secondary mb-3 px-3 py-2" style="font-size: 0.9rem;">
                            <i class="bi bi-x-circle"></i> Unavailable
                        </span>
                    {% endif %}
                    
                    {% if user.is_authenticated and not user.is_fundi %}
                        <a href="{% url 'create_booking' fundi.id %}" class="btn btn-primary w-100 mb-2 btn-lg fw-bold">
                            <i class="bi bi-calendar-check"></i> Book Me Now
                        </a>
                        {% if can_review %}
                            <a href="{% url 'create_review' completed_booking_for_review.id %}" class="btn btn-success w-100 mb-2 fw-bold">
                                <i class="bi bi-star"></i> Leave a Review
                            </a>
                        {% endif %}
                    {% elif not user.is_authenticated %}
                        <a href="{% url 'login' %}" class="btn btn-primary w-100 mb-2 btn-lg fw-bold">
                            <i class="bi bi-calendar-check"></i> Book Me Now
                        </a>
                    {% endif %}
                    <a href="{% url 'contact_fundi' fundi.id %}" class="btn btn-outline-primary w-100 fw-bold">
                        <i class="bi bi-envelope"></i> Contact Fundi
                    </a>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="depth-card">
                <div class="card-body">
                    <h5 class="card-title fw-bold"><i class="bi bi-telephone"></i> Contact Information</h5>
                    <hr>
                    {% if fundi.user.phone_number %}
                        <p><i class="bi bi-phone"></i> <strong>Phone:</strong> <a href="tel:{{ fundi.user.phone_number }}">{{ fundi.user.phone_number }}</a></p>
                    {% else %}
                        <p><i class="bi bi-phone"></i> <strong>Phone:</strong> <span class="text-muted">Not provided</span></p>
                    {% endif %}
                    {% if fundi.user.email %}
                        <p><i class="bi bi-envelope"></i> <strong>Email:</strong> <a href="mailto:{{ fundi.user.email }}">{{ fundi.user.email }}</a></p>
                    {% endif %}
                    {% if fundi.user.address %}
                        <p><i class="bi bi-geo-alt"></i> <strong>Location:</strong> {{ fundi.user.address|truncatewords:10 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="depth-card mb-4">
                <div class="card-body">
                    <h4 class="fw-bold">About</h4>
                    <p>{{ fundi.bio|default:"No bio available." }}</p>
                </div>
            </div>
            
            <!-- Recent Bookings -->
            <div class="depth-card mb-4">
                <div class="card-body">
                    <h4>Recent Bookings ({{ total_completed }} completed)</h4>
                    {% if recent_bookings %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Service</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in recent_bookings %}
                                <tr>
                                    <td>{{ booking.customer.get_full_name|default:booking.customer.username }}</td>
                                    <td>{{ booking.service.name }}</td>
                                    <td>{{ booking.booking_date|date:"M d, Y" }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if booking.status == 'completed' %}bg-success
                                            {% elif booking.status == 'cancelled' %}bg-danger
                                            {% elif booking.status == 'in_progress' %}bg-warning
                                            {% elif booking.status == 'confirmed' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ booking.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No bookings yet.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Reviews Section -->
            <div class="depth-card">
                <div class="card-body">
                    <h4 class="fw-bold">Reviews ({{ fundi.total_reviews }})</h4>
                    <hr>
                    {% for review in reviews_page %}
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <div>
                                <strong>{{ review.booking.customer.get_full_name|default:review.booking.customer.username }}</strong>
                                <span class="text-muted ms-2"><small>{{ review.created_at|date:"F d, Y" }}</small></span>
                            </div>
                            <span class="rating-stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                        <i class="bi bi-star-fill"></i>
                                    {% else %}
                                        <i class="bi bi-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </span>
                        </div>
                        <p>{{ review.comment|default:"No comment provided." }}</p>
                        <p class="text-muted"><small>Service: {{ review.booking.service.name }}</small></p>
                    </div>
                    {% empty %}
                    <p class="text-muted">No reviews yet.</p>
                    {% endfor %}
                    
                    <!-- Pagination for Reviews -->
                    {% if reviews_page.has_other_pages %}
                    <nav aria-label="Review pagination">
                        <ul class="pagination justify-content-center">
                            {% if reviews_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?review_page=1">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?review_page={{ reviews_page.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">Page {{ reviews_page.number }} of {{ reviews_page.paginator.num_pages }}</span>
                            </li>
                            
                            {% if reviews_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?review_page={{ reviews_page.next_page_number }}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?review_page={{ reviews_page.paginator.num_pages }}">Last</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Lottie Animation for Fundi Service (Hammer/Drill)
    document.addEventListener('DOMContentLoaded', function() {
        const animationContainer = document.getElementById('fundiServiceAnimation');
        if (animationContainer && typeof lottie !== 'undefined') {
            // Create a simple hammer/drill animation using Lottie
            // Using a generic tool animation JSON
            const animationData = {
                "v": "5.7.4",
                "fr": 30,
                "ip": 0,
                "op": 60,
                "w": 100,
                "h": 100,
                "nm": "Tool Animation",
                "ddd": 0,
                "assets": [],
                "layers": [{
                    "ddd": 0,
                    "ind": 1,
                    "ty": 4,
                    "nm": "Hammer",
                    "sr": 1,
                    "ks": {
                        "o": {"a": 0, "k": 100},
                        "r": {
                            "a": 1,
                            "k": [
                                {"i": {"x": [0.667], "y": [1]}, "o": {"x": [0.333], "y": [0]}, "t": 0, "s": [0]},
                                {"t": 60, "s": [360]}
                            ]
                        },
                        "p": {"a": 0, "k": [50, 50, 0]},
                        "a": {"a": 0, "k": [0, 0, 0]},
                        "s": {"a": 0, "k": [100, 100, 100]}
                    },
                    "ao": 0,
                    "shapes": [{
                        "ty": "gr",
                        "it": [{
                            "ty": "rc",
                            "d": 1,
                            "s": {"a": 0, "k": [20, 40]},
                            "p": {"a": 0, "k": [0, 0]},
                            "r": {"a": 0, "k": 5}
                        }, {
                            "ty": "fl",
                            "c": {"a": 0, "k": [0.4, 0.4, 0.4, 1]},
                            "o": {"a": 0, "k": 100}
                        }]
                    }]
                }]
            };
            
            // Try to load a hammer animation from LottieFiles or use a fallback
            try {
                // For now, we'll create a simple rotating tool icon animation
                lottie.loadAnimation({
                    container: animationContainer,
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://assets5.lottiefiles.com/packages/lf20_hammer.json' // Fallback to a simple animation
                }).catch(() => {
                    // If animation fails to load, show an icon instead
                    animationContainer.innerHTML = '<i class="bi bi-hammer" style="font-size: 4rem; color: #667eea; animation: pulse 2s infinite;"></i>';
                });
            } catch (e) {
                // Fallback to icon animation
                animationContainer.innerHTML = '<i class="bi bi-hammer" style="font-size: 4rem; color: #667eea; animation: pulse 2s infinite;"></i>';
            }
        } else if (animationContainer) {
            // Fallback if Lottie is not loaded
            animationContainer.innerHTML = '<i class="bi bi-tools" style="font-size: 4rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: pulse 2s infinite;"></i>';
        }
    });
</script>
{% endblock %}
